<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warenkorb von {{ include.user_name }}</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

<div>
    <h1>Warenkorb von {{ include.user_name }}</h1>

    <a href="../index.html"><p>Zur√ºck</p></a>

    <div>
        <button class="submit-button">Bestellung abschicken</button>

        <p id="submit-message"></p>
    </div>
</div>

<table class="goods-list">

    {% for good in site.data.goods %}

        <!-- TODO: make mobile friendly -->
        <tr class="good">
            <td>
                <img src="../assets/{{ good.img }}"/>
            </td>
            <td>
                <h2 class="good-name">{{ good.name }}</h2>
            </td>
            <td class="good-description">
                <p>{{ good.description }}</p>
            </td>
            <td>
                <div class="counter">
                    <span class="minus">-</span>
                    <input type="text" value=""/>
                    <span class="plus">+</span>
                </div>
            </td>
        </tr>

    {% endfor %}
</table>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script type="text/javascript">
    $.get("https://getpantry.cloud/apiv1/pantry/3434fa84-88b8-41ad-8cfb-36088d6c14c1/basket/orders", function (data, status) {
        const orders = data.{{ include.user_id }}Orders ?? {};
        const inputs = $('input');
        for (let i = 0; i < inputs.length; i++) {
            inputs[i].value = orders['b' + i] ?? 0;
        }
    });

    $(document).ready(function () {
        $('.minus').click(function () {
            const $input = $(this).parent().find('input');
            const oldValue = $input.val();
            if (oldValue === "")
                return false;
            let count = parseInt(oldValue) - 1;
            count = count < 0 ? 0 : count;
            $input.val(count);
            $input.change();
            return false;
        });
        $('.plus').click(function () {
            var $input = $(this).parent().find('input');
            const oldValue = $input.val();
            if (oldValue === "")
                return false;
            $input.val(parseInt(oldValue) + 1);
            $input.change();
            return false;
        });
        $('.submit-button').click(function () {
            storeData();
        });
    });

    function storeData() {
        const inputs = $('input');
        const orders = {};
        for (let i = 0; i < inputs.length; i++) {
            const v = inputs[i].value;
            if (v === "") {
                $('#submit-message').text("Fehler bei der Bestellung. Seite neu laden.");
                return false;
            }
            orders['b' + i] = Number(v);
        }
        const data = {};
        data["{{ include.user_id }}Orders"] = orders;
        $.ajax({
            type: "PUT",
            url: "https://getpantry.cloud/apiv1/pantry/3434fa84-88b8-41ad-8cfb-36088d6c14c1/basket/orders",
            contentType: "application/json",
            data: JSON.stringify(data),
            beforeSend: () => {
                $('#submit-message').text("Bitte warten...");
            },
            success: () => {
                $('#submit-message').text("Erfolgreich bestellt!");
            },
            error: () => {
                $('#submit-message').text("Fehler bei der Bestellung. In 10 Sekunden nochmal versuchen.");
            }
        });
    }
</script>

</body>

</html>
